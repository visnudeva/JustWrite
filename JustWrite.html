<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustWrite - Simple Word Processor</title>
    <!-- Library to handle PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            /* --- Light Theme --- */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --toolbar-bg: #f9fafb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* --- Dark Theme --- */
        body.dark-mode {
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --bg-color: #111827;
            --surface: #1f2937;
            --text: #f9fafb;
            --text-light: #9ca3af;
            --border: #374151;
            --toolbar-bg: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            z-index: 10;
            position: relative;
            transition: background-color 0.3s;
        }

        /* --- Brand & Menu Wrapper --- */
        .brand-wrapper {
            position: relative;
            z-index: 20;
        }

        .brand {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .brand:hover { background: rgba(128,128,128,0.1); }

        /* --- Dropdown Menu --- */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-width: 200px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.15s ease-out;
        }
        
        .dropdown-menu.show { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .menu-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--text);
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: var(--bg-color);
            color: var(--primary);
        }

        .menu-item svg {
            width: 16px; height: 16px;
            fill: currentColor;
            opacity: 0.7;
        }
        
        .menu-item:hover svg { opacity: 1; }

        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* --- Toolbar --- */
        .toolbar {
            display: flex;
            gap: 6px;
            background: var(--toolbar-bg);
            padding: 6px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            align-items: center;
            flex-wrap: wrap;
            transition: background-color 0.3s;
        }

        .tool-group {
            display: flex;
            gap: 2px;
            padding-right: 8px;
            margin-right: 8px;
            border-right: 1px solid var(--border);
        }
        .tool-group:last-child { border: none; margin: 0; padding: 0; }

        /* --- Buttons --- */
        button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            color: var(--text);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button:hover { background: rgba(128,128,128,0.15); color: var(--primary); }
        button.active { background: var(--primary); color: white; }
        button svg { width: 18px; height: 18px; fill: currentColor; }
        
        /* --- Inputs --- */
        select {
            border: none; background: transparent; font-size: 0.9rem; cursor: pointer; padding: 4px; border-radius: 4px; color: var(--text);
        }

        /* --- Editor Area --- */
        main {
            flex: 1;
            display: flex;
            justify-content: center;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
        }

        #editor {
            width: 100%;
            max-width: 816px; /* A4 width approx */
            min-height: 1056px; /* A4 height approx */
            background: var(--surface);
            box-shadow: var(--shadow);
            padding: 3rem;
            line-height: 1.6;
            font-size: 16px;
            outline: none;
            transition: background-color 0.3s;
        }
        
        #editor:empty:before {
            content: "Start typing...";
            color: var(--text-light);
            pointer-events: none;
        }
        
        #editor a { color: var(--primary); text-decoration: underline; }

        /* --- Footer --- */
        footer {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 0.5rem 1.5rem;
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            transition: background-color 0.3s;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }
        .modal {
            background: var(--surface); color: var(--text);
            padding: 2rem; border-radius: var(--radius);
            width: 90%; max-width: 400px; box-shadow: var(--shadow);
            text-align: center; border: 1px solid var(--border);
        }
        .modal h3 { margin-top: 0; }
        .modal-btn {
            display: block; width: 100%; padding: 10px; margin: 10px 0;
            border-radius: 6px; border: 1px solid var(--border);
            background: var(--bg-color); cursor: pointer; font-weight: 600; color: var(--text);
        }
        .modal-btn:hover { border-color: var(--primary); color: var(--primary); }
        .close-modal { margin-top: 1rem; background: transparent; border: none; text-decoration: underline; cursor: pointer; color: var(--text-light);}

        /* --- Toast --- */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: #333; color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 0.9rem;
            opacity: 0; transform: translateY(20px); transition: all 0.3s;
            pointer-events: none; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            z-index: 200;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* --- Print --- */
        @media print {
            header, footer, .toast, .modal-overlay { display: none !important; }
            body, main { background: white; height: auto; overflow: visible; padding: 0; margin: 0; }
            #editor { box-shadow: none; padding: 0; width: 100%; max-width: 100%; background: white; color: black; }
        }

        /* Mobile */
        @media (max-width: 768px) {
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .toolbar { width: 100%; overflow-x: auto; justify-content: flex-start; }
            .brand-wrapper { width: 100%; }
            .brand { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <header>
        <!-- Brand & Rolling Menu -->
        <div class="brand-wrapper">
            <div class="brand" onclick="toggleMenu(event)">
                <div style="display:flex; align-items:center; gap:8px">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg>
                    JustWrite
                </div>
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="opacity:0.5"><path d="M7 10l5 5 5-5z"/></svg>
            </div>

            <div class="dropdown-menu" id="mainMenu">
                <!-- New Document -->
                <div class="menu-item" onclick="newDocument(event)">
                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    New
                </div>

                <div class="menu-divider"></div>

                <!-- Open -->
                <div class="menu-item" onclick="triggerOpen(event)">
                    <svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
                    Open File...
                </div>
                
                <div class="menu-divider"></div>

                <!-- Save As -->
                <div class="menu-item" onclick="triggerSave(event)">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    Save As...
                </div>

                <!-- PDF -->
                <div class="menu-item" onclick="triggerPDF(event)">
                    <svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>
                    Export PDF
                </div>

                <div class="menu-divider"></div>

                <!-- Print -->
                <div class="menu-item" onclick="triggerPrint(event)">
                    <svg viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
                    Print
                </div>

                <!-- Email -->
                <div class="menu-item" onclick="triggerEmail(event)">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                    Email Text
                </div>
            </div>
        </div>

        <!-- Formatting Toolbar -->
        <div class="toolbar">
            <!-- Theme Toggle -->
            <div class="tool-group">
                <button id="theme-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                    <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                </button>
            </div>

            <div class="tool-group">
                <button onclick="execCmd('undo')" title="Undo"><svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg></button>
                <button onclick="execCmd('redo')" title="Redo"><svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg></button>
            </div>
            
            <div class="tool-group">
                <select onchange="execCmdWithArg('fontName', this.value)"><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Courier New">Courier New</option><option value="Georgia">Georgia</option></select>
                <select onchange="execCmdWithArg('fontSize', this.value)"><option value="1">Small</option><option value="3">Normal</option><option value="5">Large</option><option value="7">Huge</option></select>
            </div>

            <div class="tool-group">
                <button onclick="execCmd('bold')" title="Bold"><svg viewBox="0 0 24 24"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg></button>
                <button onclick="execCmd('italic')" title="Italic"><svg viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg></button>
                <button onclick="execCmd('underline')" title="Underline"><svg viewBox="0 0 24 24"><path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/></svg></button>
                <button onclick="execCmdWithArg('foreColor', promptColor())" title="Text Color"><svg viewBox="0 0 24 24"><path d="M17.25 12.76l-3.29 6.45c-.19.38-.68.49-1.02.24l-1.23-.9-2.18 4.26c-.29.57-1.14.52-1.35-.08L5.08 13.9c-.22-.63.35-1.24 1-.98l2.64 1.05 4.66-9.11c.34-.67 1.35-.64 1.65.05l2.22 4.85z"/></svg></button>
            </div>

            <div class="tool-group">
                <button onclick="execCmd('justifyLeft')" title="Align Left"><svg viewBox="0 0 24 24"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg></button>
                <button onclick="execCmd('justifyCenter')" title="Center"><svg viewBox="0 0 24 24"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button>
                <button onclick="execCmd('justifyRight')" title="Right"><svg viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button>
            </div>

            <div class="tool-group">
                <button onclick="insertLink()" title="Insert Link"><svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></button>
                <button onclick="execCmd('insertUnorderedList')" title="List"><svg viewBox="0 0 24 24"><path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12.17c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.68-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z"/></svg></button>
                <button onclick="execCmd('removeFormat')" title="Clear Formatting"><svg viewBox="0 0 24 24"><path d="M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3v10zM14 5h-3l-1-1H6L5 5H2v2h12z"/></svg></button>
            </div>
        </div>
    </header>

    <main onclick="document.getElementById('editor').focus()">
        <div id="editor" contenteditable="true" spellcheck="true"></div>
    </main>

    <footer>
        <span id="word-count">0 words</span>
        <span id="status">Ready</span>
    </footer>

    <!-- Hidden Input for Opening Files -->
    <input type="file" id="fileInput" style="display: none;" accept=".html,.txt,.htm,.md">

    <!-- Save Modal -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <h3>Save Document</h3>
            <button class="modal-btn" onclick="saveFile('html')">
                Web Page (.html) 
                <br><small>(Best for LibreOffice & Word)</small>
            </button>
            <button class="modal-btn" onclick="saveFile('md')">
                Markdown (.md) 
                <br><small>(For GitHub & Notes)</small>
            </button>
            <button class="modal-btn" onclick="saveFile('txt')">Plain Text (.txt)</button>
            <button class="close-modal" onclick="closeSaveModal()">Cancel</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">Notification</div>

    <script>
        const editor = document.getElementById('editor');
        const fileMenu = document.getElementById('mainMenu');
        const DRAFT_KEY = 'justwrite_autosave';

        // --- Auto Save System ---
        setInterval(() => {
            const content = editor.innerHTML;
            localStorage.setItem(DRAFT_KEY, content);
            
            document.getElementById('status').innerText = "Autosaved";
            
            // Briefly fade status to indicate save
            const statusEl = document.getElementById('status');
            statusEl.style.opacity = '0.5';
            setTimeout(() => statusEl.style.opacity = '1', 500);

        }, 10000); // 10 Seconds

        function loadDraft() {
            const saved = localStorage.getItem(DRAFT_KEY);
            if (saved && saved.length > 0) {
                editor.innerHTML = saved;
                showToast("Draft restored");
                updateStats();
            }
        }

        // --- Menu Logic ---
        function toggleMenu(event) {
            event.stopPropagation();
            fileMenu.classList.toggle('show');
        }

        window.addEventListener('click', () => {
            if (fileMenu.classList.contains('show')) {
                fileMenu.classList.remove('show');
            }
        });

        fileMenu.addEventListener('click', (e) => { e.stopPropagation(); });

        // --- Trigger Functions ---
        function triggerOpen(e) { fileMenu.classList.remove('show'); document.getElementById('fileInput').click(); }
        function triggerSave(e) { fileMenu.classList.remove('show'); showSaveModal(); }
        function triggerPDF(e) { fileMenu.classList.remove('show'); savePDF(); }
        function triggerPrint(e) { fileMenu.classList.remove('show'); printDoc(); }
        function triggerEmail(e) { fileMenu.classList.remove('show'); emailDoc(); }
        
        function newDocument(event) {
            if(event) event.stopPropagation();
            if(confirm("Create a new document? Unsaved changes in draft will be lost.")) {
                editor.innerHTML = "";
                localStorage.removeItem(DRAFT_KEY);
                updateStats();
                showToast("New Document");
            }
        }

        // --- Theme Management ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const btn = document.getElementById('theme-btn');
            if (isDark) {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>';
            } else {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>';
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                updateThemeIcon(true);
            }
            loadDraft();
        });

        // --- Editor Functions ---
        function execCmd(cmd) { document.execCommand(cmd, false, null); editor.focus(); }
        function execCmdWithArg(cmd, arg) { document.execCommand(cmd, false, arg); editor.focus(); }
        function promptColor() { return prompt("Enter color (e.g., red, #ff0000):", "#000000") || "#000000"; }
        function insertLink() { const url = prompt("Enter URL:", "https://"); if(url) document.execCommand('createLink', false, url); }

        function updateStats() {
            const text = editor.innerText || "";
            const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('word-count').innerText = `${words} words`;
        }
        editor.addEventListener('input', updateStats);

        // --- Markdown Converter ---
        function convertToMarkdown() {
            let html = editor.innerHTML;
            let md = html;
            md = md.replace(/<strong>/g, "**").replace(/<\/strong>/g, "**");
            md = md.replace(/<b>/g, "**").replace(/<\/b>/g, "**");
            md = md.replace(/<em>/g, "*").replace(/<\/em>/g, "*");
            md = md.replace(/<i>/g, "*").replace(/<\/i>/g, "*");
            md = md.replace(/<a href="(.*?)">(.*?)<\/a>/g, "[$2]($1)");
            md = md.replace(/<h1>/g, "# ").replace(/<\/h1>/g, "\n\n");
            md = md.replace(/<h2>/g, "## ").replace(/<\/h2>/g, "\n\n");
            md = md.replace(/<h3>/g, "### ").replace(/<\/h3>/g, "\n\n");
            md = md.replace(/<\/?ul>/g, "");
            md = md.replace(/<\/?ol>/g, "");
            md = md.replace(/<li>/g, "- ");
            md = md.replace(/<\/li>/g, "\n");
            md = md.replace(/<p>/g, "").replace(/<\/p>/g, "\n\n");
            md = md.replace(/<br>/g, "\n");
            md = md.replace(/<div>/g, "").replace(/<\/div>/g, "\n");
            md = md.replace(/&nbsp;/g, " ");
            md = md.replace(/&lt;/g, "<");
            md = md.replace(/&gt;/g, ">");
            md = md.replace(/\n\s*\n\s*\n/g, "\n\n");
            return md.trim();
        }

        // --- PDF Saving ---
        function savePDF() {
            const element = document.getElementById('editor');
            const isDark = document.body.classList.contains('dark-mode');
            if(isDark) document.body.classList.remove('dark-mode');

            showToast("Generating PDF...");
            const opt = {
                margin:       10, 
                filename:     'document.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                showToast("PDF Saved!");
                if(isDark) document.body.classList.add('dark-mode');
            }).catch(err => {
                console.error(err);
                showToast("Error generating PDF");
                if(isDark) document.body.classList.add('dark-mode');
            });
        }

        function printDoc() { window.print(); }

        function emailDoc() {
            const text = editor.innerText;
            if (text.length > 2000) {
                if(!confirm("Document is long. Email clients might truncate it. Continue?")) return;
            }
            const subject = encodeURIComponent("Shared from JustWrite");
            const body = encodeURIComponent(text);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
            showToast("Opening email client...");
        }

        function showSaveModal() { document.getElementById('saveModal').style.display = 'flex'; }
        function closeSaveModal() { document.getElementById('saveModal').style.display = 'none'; }

        function saveFile(type) {
            closeSaveModal();
            let content, filename, mimeType;
            const baseName = (prompt("Filename:", "document") || "document");

            if (type === 'html') {
                content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Doc</title><style>body { font-family: sans-serif; padding: 40px; }</style></head><body>${editor.innerHTML}</body></html>`;
                filename = baseName + ".html";
                mimeType = 'text/html';
            } else if (type === 'md') {
                content = convertToMarkdown();
                filename = baseName + ".md";
                mimeType = 'text/markdown';
            } else {
                content = editor.innerText;
                filename = baseName + ".txt";
                mimeType = 'text/plain';
            }

            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast(`Saved ${filename}`);
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.name.toLowerCase().endsWith('.pdf')) {
                showToast("Error: PDFs cannot be opened for editing.");
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            const name = file.name.toLowerCase();
            const isHtml = name.endsWith('.html') || name.endsWith('.htm');
            const isMd = name.endsWith('.md');

            reader.onload = (event) => {
                if (isHtml) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(event.target.result, 'text/html');
                    editor.innerHTML = doc.body.innerHTML;
                } else if (isMd) {
                    let mdText = event.target.result;
                    let html = mdText
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/^- (.*)/g, '<li>$1</li>');
                    editor.innerHTML = html;
                } else {
                    editor.innerText = event.target.result;
                }
                
                showToast(`Opened ${file.name}`);
                updateStats();
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            document.getElementById('status').innerText = msg;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        updateStats();
    </script>
</body>
</html>
